---
layout: module
title: S3
image: assets/img/s3.png
description: Create and manage S3 buckets
---
Overview
--------
Cumulus makes using Amazon S3 easier and cleaner! Easily configure buckets! Share CORS and policy configuration between buckets! Read the following sections to learn about configuring your S3 environment with Cumulus. Example configuration can be found in the [Cumulus repo](https://github.com/lucidsoftware/cumulus).

Bucket Definition
-----------------

Each S3 bucket is defined in its own file, and the folder distributions are located in is [configurable](#configuration). File names for S3 bucket configuration correspond to the name of that bucket and are also the name that Cumulus will use to refer to your bucket in its output, and as input into its command line interface (minus the `.json`, of course). Buckets are JSON objects with the following attributes:

* `region` - the region of the bucket
* `permissions` -
  * `cors` - a JSON object configuring the cors template. See [CORS Templates](#cors-templates) to learn how to create these templates. Has the following properties:
    * `template` - the name of the template to include
    * `vars` - a JSON object of variables in the template to override
  * `policy` - a JSON object configuring the policy template. See [Policy Templates](#policy-templates) to lear how to create templates.  Has the following properties:
    * `template` - the name of the template to include
    * `vars - a JSON object of variables in the template to override
  * `grants` - see [Grants](#grants)
* `website` -
  * `redirect` - the protocol and hostname to redirect all traffic to when a request is received to an object in the bucket e.g. `"https://www.example.com"`. Should not be defined if `index` is defined
  * `index` - the object to serve when requesting a directory i.e. if `index` is `index.html` and a request is made to `/posts/` then `/posts/index.html` will be served. Should not be defined if `redirect` is defined
  * `error` - the object to serve when a 4XX error occurs. Should only be defined if `redirect` is not defined.
* `logging` - optionally configure a bucket in which to store logs that contain information about access to this bucket
  * `target-bucket` - the name of the bucket in which to store logs
  * `prefix` - the prefix to give to all generated log files
* `notifications` -
  * `name` -
  * `triggers` -
  * `prefix` -
  * `suffix` -
  * `type` -
  * `target` -
* `lifecycle` -
  * `name` -
  * `prefix` -
  * `days-until-glacier` -
  * `days-until-delete` -
  * `past-versions` -
    * `days-until-glacier` -
    * `days-until-delete` -
* `versioning` - a true/false value indicating if versioning is enabled on items in the bucket
* `replication` - an optional configuration that defines bucket replication. It has the following properties:
  * `iam-role` - the name of the IAM role to use for replicating the bucket
  * `prefixes` - an array of prefixes of the objects that replication applies to e.g. `["images/", "js/""]`. Omit to repicate the entire bucket
  * `destination` - the name of the destination bucket for replicated items
* `tags` - an optional JSON object that specifies the tags to include on the bucket.  Each tag is in the form of `"key": "value"`

Here is an example of a bucket configuration:

{% highlight json %}
{
  "region": "us-east-1",
  "permissions": {
    "cors": {
      "template": "example-cors",
      "vars": {}
    },
    "policy": {
      "template": "example-policy",
      "vars": {
        "bucket": "example-bucket"
      }
    },
    "grants": [
      {
        "name": "your-account",
        "id": "328ead623599bb1a2fc207d606cec78f54d201ed6e19db5f056a406bac48b77c",
        "permissions": ["list"]
      }
    ]
  },
  "website": {
    "index": "index.html",
    "error": "error-pages/error.html"
  },
  "logging": {
    "target-bucket": "logging-bucket",
    "prefix": "logs/"
  },
  "notifications": [
    {
      "name": "example-notification",
      "triggers": [
        "ObjectCreated:*"
      ],
      "prefix": "a",
      "suffix": "z",
      "type": "sns",
      "target": "example-topic"
    }
  ],
  "lifecycle": [
    {
      "name": "lifecycle-rule",
      "prefix": "a",
      "days-until-glacier": 10,
      "days-until-delete": 100,
      "past-versions": {
        "days-until-glacier": 5,
        "days-until-delete": 120
      }
    }
  ],
  "versioning": true,
  "replication": {
    "iam-role": "a-role",
    "prefixes": [
      "a",
      "z"
    ],
    "destination": "backup-bucket"
  },
  "tags": {
    "a key": "a value"
  }
}
{% endhighlight %}

### CORS Templates

CORS controls which origins have access to the content in your bucket. A CORS template has the following properties:

* `origins` - an array of origins that are allowed to access content on the bucket e.g. `["www.example.com"]`
* `methods` - an array of methods that the origins are allowed to execute e.g. `["GET", "HEAD"]`
* `headers` - an array of headers that are allowed in a pre-flight `OPTIONS` request
* `exposed-headers` - an array headers that a client will be able to access from their application e.g. `["Origin"]`
* `max-age-seconds` - the number of seconds that a browser is allowed to cache a preflight response from the specified origins

Here is an example CORS configuration:

{% highlight json %}
[
  {
    "headers": [
      "Authorization"
    ],
    "methods": [
      "GET"
    ],
    "origins": [
      "*"
    ],
    "exposed-headers": [],
    "max-age-seconds": 86400
  }
]
{% endhighlight %}

### Policy Templates

Policies control access to the S3 bucket and its resources. Cumulus mirrors the format used by AWS for configuring policies. A detailed explanation of bucket policies by AWS can be found [here](http://docs.aws.amazon.com/AmazonS3/latest/dev/example-bucket-policies.html).

Here is an example policy configuration which allows public access to objects in `examplebucket`:

{% highlight json %}
{
  "Version":"201=5-08-28",
  "Statement":[
    {
      "Sid":"PublicGets",
      "Effect":"Allow",
      "Principal": "*",
      "Action":["s3:GetObject"],
      "Resource":["arn:aws:s3:::examplebucket/*"]
    }
  ]
}
{% endhighlight %}

### Grants

Grants control which accounts have permissions to perform actions on your bucket. A grants configuration has the following properties:

* `name` - the name of the account
* `email` - the email address of the account. Not required if `id` is defined
* `id` - the canonical AWS id of the account. Not required if `email` is defined
* `permissions` - an array of which permissions are given to the account. Valid values include `"all"`, `"list"`, `"update"`, `"view-permissions"`, and `"edit-permissions"`

Here is an example CORS configuration:

{% highlight json %}
copy pasta
{% endhighlight %}

There are some configuration options for S3 buckets that Cumulus does not handle because we do not use them at Lucid or do not want them managed by Cumulus at this time. These include:

* `blah`

Some configuration options have limits imposed on them by Cumulus because it better fits Lucid's needs. These include:

* `replication` - only one rule for replication can be specified per bucket

If you would like any of these limitations changed, please submit a pull request.


Diffing and Syncing S3
------------------------------

Cumulus's S3 module has the following usage:

{% highlight bash %}
cumulus cloudfront [diff|help|list|migrate|sync] <asset>
{% endhighlight %}

S3 buckets can be diffed, listed, and synced (migration is covered in the [following section](#migration)). The three actions do the following:

* `diff` - Shows the differences between the local definition and the AWS CloudFront configuration. If `<asset>` is specified, Cumulus will diff only the distribution defined in that file.
* `list` - Lists the names of the files that contain distribution definitions
* `sync` - Syncs local configuration with AWS. If `<asset>` is specified, Cumulus will sync only the distribution defined in the file with that name.

Migration
---------

If your environment is anything like ours, you have dozens of S3 buckets, and would rather not write Cumulus configuration for them by hand. Luckily, Cumulus provides a `migrate` task that will pull down your buckets and produce configuration for them.


Configuration
-------------
Cumulus reads configuration from a configuration file, `conf/configuration.json` (the location of this file can also be specified by running cumulus with the `--config` option). The values in `configuration.json` can be changed to customized to change some of Cumulus's behavior. The following is a list of the values in `configuration.json` that pertain to the S3 module:

* `$.s3.buckets.directory` - the directory where Cumulus expects to find S3 bucket definitions. Defaults to `conf/s3/buckets`.
* `$.s3.buckets.cors.directory` - the directory where Cumulus expects to find CORS definitions. Defaults to `conf/s3/cors`.
* `$.s3.buckets.policies.directory` - the directory where Cumulus expects to find policy definitions. Defaults to `conf/s3/policies`.
